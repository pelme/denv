name: "Build dynamic and static binaries"
on:
  # pull_request:
  #   types: [opened, synchronize, reopened]

  push:
    branches:
      - 'deni/gh-test'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
        include:
        - os: macos-latest
          OS_NAME: osx
          TARCMD: gtar
        - os: ubuntu-latest
          OS_NAME: linux
          TARCMD: tar
    steps:
    - name: Checkout
      uses: actions/checkout@v2.3.1

    - name: Cache global ~/.stack
      id:   stack-global
      uses: actions/cache@v2
      with:
        path: ~/.stack
        key: ${{ runner.os }}-stack-global-${{ hashFiles('stack.yaml.lock') }}
        restore-keys: |
             ${{ runner.os }}-stack-global

    - name: Cache stack-installed programs in ~/.local/bin
      id:   stack-programs
      uses: actions/cache@v2
      with:
        path: ~/.local/bin
        key: ${{ runner.os }}-stack-programs-${{ hashFiles('stack.yaml.lock') }}
        restore-keys: |
             ${{ runner.os }}-stack-programs

    - name: Cache .stack-work
      uses: actions/cache@v2
      with:
        path: .stack-work
        key: ${{ runner.os }}-stack-work-${{ hashFiles('stack.yaml.lock') }}
        restore-keys: |
             ${{ runner.os }}-stack-work

    - name: Install gnu-tar (only on MacOS)
      run: brew install gnu-tar
      if: matrix.os == 'macos-latest'

    - name: Install stack
      run: |
        mkdir -p ~/.local/bin
        export PATH=~/.local/bin:$PATH
        if [[ ! -x ~/.local/bin/stack ]]; then curl -sL https://get.haskellstack.org/stable/${{ matrix.OS_NAME }}-x86_64.tar.gz | ${{ matrix.TARCMD }} xz --wildcards --strip-components=1 -C ~/.local/bin '*/stack'; chmod a+x ~/.local/bin/stack; fi
        stack --version

    #- uses: cachix/install-nix-action@v11
    #  with:
    #    nix_path: nixpkgs=channel:nixos-19.09
    #- uses: cachix/cachix-action@v6
    #  with:
    #    name: deni
    #    signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'
    #    # Only needed for private caches
    #    #authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - run: echo "::set-env name=SHORT_SHA::$(git rev-parse --short HEAD)"
    - run: echo "::set-env name=VERSION::$(make version)"
    - name: Stack setup
      run: stack --no-terminal setup --no-reinstall > /dev/null
    - name: Stack test
      run: stack --no-terminal test
    - name: Stack install
      run: stack --no-terminal install
    - name: Create release artifact
      run: |
        cp ~/.local/bin/denv .
        tar -czf denv-$VERSION-${{ runner.os }}-x86_64.tar.gz denv
    # - name: Create Release
    #   id: create_release
    #   uses: actions/create-release@v1
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
    #   with:
    #     tag_name: ${{ github.ref }}
    #     release_name: v${{ github.ref }}
    #     body: |
    #       Automated release. Update with changelog.
    #     draft: true
    #     prerelease: false
    # - name: Upload Release Asset
    #   id: upload-release-asset
    #   uses: actions/upload-release-asset@v1
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #   with:
    #     upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
    #     asset_path: ./denv.tar.gz
    #     asset_name: denv-${{ github.ref }}-${{ runner.os }}-x86_64.tar.gz
    #     asset_content_type: application/gzip
